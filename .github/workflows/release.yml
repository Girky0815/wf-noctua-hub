name: Release and Deploy

on:
  push:
    tags:
      - "v*"

# GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ã«å¿…è¦ãªæ¨©é™
permissions:
  contents: write
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã®åˆ¶å¾¡ (é€²è¡Œä¸­ã®ãƒ“ãƒ«ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«)
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: å¤‰æ›´å±¥æ­´ã®æŠ½å‡º
        id: changelog
        run: |
          # Remove 'v' prefix from tag to match version in updates.ts
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "ğŸ“ å¤‰æ›´å±¥æ­´ã‚’æŠ½å‡ºä¸­ (Version: $VERSION)..."
          node scripts/extract-changelog.js $VERSION > RELEASE_BODY.md
          echo "âœ… å¤‰æ›´å±¥æ­´ã®æŠ½å‡ºå®Œäº†"

      - name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_BODY.md
          draft: false
          prerelease: false

  build:
    name: ãƒ“ãƒ«ãƒ‰ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä½œæˆ
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci
          echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ğŸ—ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          npm run build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: GitHub Pages ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    name: GitHub Pages ã¸ã®åæ˜ 
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: "github-pages"
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
        id: deployment
        uses: actions/deploy-pages@v4
